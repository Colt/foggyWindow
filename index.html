<!doctype html>
<html lang="en">
	<head>
		<title>facetracking</title>
		<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
		<meta charset="utf-8">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-32642923-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
	</head>
	<div id="images"></div>
	<canvas style="margin:0;padding:0;position:absolute; border: 1px solid #000; z-index:1000000002" id="imgCanvas" width="320" height="240">
	</canvas>

	<body>

		<iframe width="320" height="240" src="https://www.youtube.com//v/zRMoi-xipQ0?playlist=zRMoi-xipQ0&autoplay=1&rel=0" frameborder="0" allowfullscreen>
		</iframe>

		<script src="./js/headtrackr.js"></script>
		
		<canvas id="compare" width="320" height="240" style="display:none"></canvas>
		<video id="vid" autoplay loop width="320" height="240"></video>
		<canvas id="overlay" width="320" height="240"></canvas>
		<canvas id="debug" width="320" height="240"></canvas>
		
		<script>
		  // set up video and canvas elements needed
		  var isTracking = false;

			var xCenter;
			var yCenter;
			var videoInput = document.getElementById('vid');
			var canvasInput = document.getElementById('compare');
			var canvasOverlay = document.getElementById('overlay');
			var debugOverlay = document.getElementById('debug');
			var overlayContext = canvasOverlay.getContext('2d');
			canvasOverlay.style.position = "absolute";
			canvasOverlay.style.top = '0px';
			canvasOverlay.style.zIndex = '100001';
			canvasOverlay.style.display = 'block';
			debugOverlay.style.position = "absolute";
			debugOverlay.style.top = '0px';
			debugOverlay.style.zIndex = '100002';
			debugOverlay.style.display = 'none';
			

			// the face tracking setup
			
			var htracker = new headtrackr.Tracker({
				calcAngles : true,
				ui : false,
				headPosition : false,
				debug : debugOverlay
			});

			htracker.init(videoInput, canvasInput);
			htracker.start();
			
			// for each facetracking event received draw rectangle around tracked face on canvas
			document.addEventListener("facetrackingEvent", function( event ) {
				// clear canvas
				overlayContext.clearRect(0,0,320,240);
				if (event.detection == "CS") {
					overlayContext.translate(event.x, event.y);
					overlayContext.rotate(event.angle-(Math.PI/2));
					overlayContext.strokeStyle = "#00CC00";
					// This draws the coordinates of my mouth in a rectangle shape
					// In the middle of this box is where the middle of my mouth is
					overlayContext.strokeRect((-(event.width/3)) >> 0, (-(event.height/2) + 85) >> 0, ((event.width/5)+ 70), event.height/5);
					overlayContext.rotate((Math.PI/2)-event.angle);
					overlayContext.translate(-event.x, -event.y);

					var x1 = (-(event.width/3)) >> 0;
					var y1 = (-(event.height/2) + 85) >> 0;
					var x2 = ((event.width/5)+ 70);
					var y2 = (event.height/5);
					xCenter = ((x1 +x2)/2) + event.x;
          yCenter = ((y1 + y2)/2) + event.y;

				// This determines if my face is close to the screen
				var faceWidth = event.width;
        var videoWidth = videoInput.width;
        var face2canvasRatio = videoWidth/faceWidth;
        
        
        if(face2canvasRatio <= 2.4) {

        	console.log("You're up close!");

					var canvas = document.getElementById("imgCanvas");
					var context = canvas.getContext("2d");
					var coords = [
						[(xCenter - 20), (yCenter - 10), 20, "rgba(209,210,210,.07)"],
						[(xCenter - 30), (yCenter - 25), 10, "rgba(209,210,210,.04)"],
						[(xCenter - 5), (yCenter - 5), 5, "rgba(209,210,210,.03)"],
						[(xCenter - 35), (yCenter), 15, "rgba(209,210,210,.05)"],
						[(xCenter), (yCenter), 12, "rgba(209,210,210,.03)"],
						[(xCenter), (yCenter + 10), 5, "rgba(209,210,210,.03)"],
						[(xCenter + 20), (yCenter - 40), 4, "rgba(209,210,210,.03)"],
						[(xCenter - 20), (yCenter + 30), 12, "rgba(209,210,210,.02)"]
						];
					for(var i = 0; i < coords.length; i++) {
						context.beginPath(); // Start the path
						context.arc(coords[i][0], coords[i][1], coords[i][2], 0, Math.PI*2, false);
							context.closePath();
							context.fillStyle = coords[i][3];
							context.fill();
					}
					// context.beginPath(); // Start the path
					// FOR SOME REASON, IT LOOKS BETTER WITH THESE MEASURMENTS, EVEN THOUGH IT DOESN'T COORELATE TO CONSOLE.LOG ABOVE
					// context.arc((xCenter - 20), (yCenter - 10), 30, 0, Math.PI*2, false); // Draw a circle
					// context.closePath(); // Close the path
					// context.fillStyle = "rgba(209,210,210,.07)";
					// context.fill(); // Fill the path
        } // If statement for face2canvasratio 
				} // This ends the if statement for event.detection
			});

    // document.addEventListener("mousedown", function(e){
    // 			isTracking = true;
				// });

    // document.addEventListener("mousemove", function(e){
    // 	var lastMouseCoords;
    // 	if(isTracking === true) {
    // 			var canvas = document.getElementById("imgCanvas");
				// 	var context = canvas.getContext("2d");
				// 	var mouseX = e.clientX;
    // 			var mouseY = e.clientY;

    			// THIS ONE DIDN'T WORK
    	// 		context.globalCompositeOperation = "xor";
					// context.beginPath();
					// context.moveTo(mouseX , mouseY);
					// context.lineTo(mouseX - canvas.offsetLeft, mouseY - canvas.offsetTop);
					// context.strokeStyle = "rgba(0,0,0,1)";
					// context.closePath();

    			// This one is interesting - the globalCompositeOperation could potentially be modified to fade out the fog???
    			// context.globalCompositeOperation="destination-out";
    			// context.arc(mouseX, mouseY, 1, 0, Math.PI*2, false);
    			// context.fill();

    			// THIS ONE WORKS BUT LEAVES JUMPS AND JAGGED LINES
					// context.clearRect(mouseX, mouseY, 4, 8);
					// context.clearRect(mouseX, mouseY, 6, 6);
					// context.clearRect(mouseX, mouseY, 5, 7);
    // 	}
    // });

    // document.addEventListener("mouseup", function(e) {
    // 	isTracking = false;
    // });
			
		</script>

    <script type="text/javascript">
		var clickX = new Array();
		var clickY = new Array();
		var clickDrag = new Array();
		var paint;
		var canvas = document.getElementById("imgCanvas"),
				context = canvas.getContext("2d");
		
		function addClick(x, y, dragging)
		{
		  clickX.push(x);
		  clickY.push(y);
		  clickDrag.push(dragging);
		}
		function redraw(){
		  //context.clearRect(0, 0, context.canvas.width, context.canvas.height); // Clears the canvas
		  context.strokeStyle = "rgba(0,0,0,1)";
			// context.lineJoin = "round";
		  context.lineJoin = context.lineCap = "round";
			context.shadowBlur = 3;
			context.shadowColor = "rgba(0,0,0,1)";
		  context.lineWidth = 4;
			context.globalCompositeOperation = "destination-out";
		  for(var i=0; i < clickX.length; i++) {
				context.beginPath();
		    if(clickDrag[i] && i){
		      context.moveTo(clickX[i-1], clickY[i-1]);
		     }else{
		       context.moveTo(clickX[i]-1, clickY[i]);
		     }
		     context.lineTo(clickX[i], clickY[i]);
		     context.closePath();
		    	context.stroke();
		  }
		}
		$('#imgCanvas').mousedown(function(e){
		  var mouseX = e.pageX - this.offsetLeft;
		  var mouseY = e.pageY - this.offsetTop;
		  paint = true;
		  addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
		  redraw();
		});
		$('#imgCanvas').mousemove(function(e){
		  if(paint){
		    addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
		    redraw();
		  }
		});
		$('#imgCanvas').mouseup(function(e){
		  paint = false;
		});
		$('#imgCanvas').mouseleave(function(e){
		  paint = false;
		});
		</script>
	</body>
</html>